<html>
  <div id="seleccionDeCurso" style="display:none;">
  </div>
  <div id="ui" style="display:none;">
    <span id="curso">
      Curso:
      <select onchange="cambiarCurso();" id="selectorCurso"></select>
    </span>
    Ejercicio: <span id="ejercicioSeleccionado">Ninguno</span>
    <button id="abrirEjercicio" onclick="abrirEjercicio();">Abrir</button>
    <button onclick="verEnunciado();">Enunciado</button>
    <span id="lenguaje">
      Lenguaje:
      <select id="selectorLenguaje">
        <option value="Python" selected>Python</option>
        <option value="Gobstones">Gobstones</option>
      </select>
    </span>
    <br/>
    <textarea id="src" style="width:calc(100% - 10px); height:calc(100% - 55px); margin:5px;"></textarea>
    <br/>
    <span id="dni"></span>
    Sevidor:
    <input type="text" value="157.92.26.235" id="url" style="width:100px">
    :
    <input type="text" value="8000" id="port" style="width:50px">
    <button onclick="run_code();">¡Enviar!</button>
  </div>
  <div id="espera" style="display:none;">
    Conectando con el servidor...
  </div>
  <script>

    const info = {}; // dni, curso, ejercicio, ...

    const v = {a: 0, r: 0, n: 0, v: 0}; // Celda vacía
    const r = {a: 0, r: 1, n: 0, v: 0}; // Celda con una roja
    const a = {a: 1, r: 0, n: 0, v: 0}; // Celda con una azul
    // Edificio con h pisos, d departamentos por piso y a ambientes por departamento
    const ed = function(h,d=0,a=0) { return {a: 0, r: h, n: 0, v: 1}; };

    const cursos = {
      inpr_unq_2023_s1:{
        nombre:"Introducción a la Programación - UNQ (2023s1)",
        lenguaje:"Gobstones",
        lenguaje_display:"none",
        ejs:[
          {
            nombre:"Presente 30/3",
            enunciado:"Escribir un programa que construya una ciudad escalera de tamaño 3 desde la celda actual hacia el Oeste. El cabezal debe finalizar sobre el edificio más alto de la ciudad construida.\n\nUna ciudad es sólo una hilera de edificios consecutivos y su tamaño es la cantidad de edificios que tiene. Decimos que una ciudad es \"escalera\" si al recorrerla de Oeste a Este, el primero de sus edificios tiene dos pisos de altura y cada uno de los demás tiene un piso de altura más que el edificio anterior.\n\nCada edificio ocupa una celda del tablero y se representa con una bolita verde y tantas bolitas rojas como pisos este tenga.",
            pre:"",
            run_data:[{
              tablero:{head:[3,1],width:5,height:3,board:[[v,v,v],[v,v,v],[v,v,v],[v,v,v],[v,v,v]]},
              post:{head:[3,1],width:5,height:3,board:[[v,v,v],[v,ed(2),v],[v,ed(3),v],[v,ed(4),v],[v,v,v]]},
            }],
            pidePrograma: true
          },{
            nombre:"Presente 27/3",
            enunciado:"Suponiendo que se encuentran definidos los procedimientos PintarBlanco y PintarNegro que pintan la celda actual de blanco y de negro respectivamente, escribir el procedimiento PintarTableroDeAjedrez que, suponiendo que el tablero tiene exactamente 8 filas y 8 columnas, pinte todo el tablero como un tablero de ajedrez. Tener en cuenta que este procedimiento debe funcionar sin importar la ubicación inicial del cabezal y no se pide que este finalice en alguna ubicación en particular",
            pre:"procedure PintarBlanco(){Poner(Rojo)}\nprocedure PintarNegro(){Poner(Azul)}\nprogram {PintarTableroDeAjedrez()}",
            run_data:[{
              tablero:{head:[5,6],width:8,height:8,board:[[v,v,v,v,v,v,v,v],[v,v,v,v,v,v,v,v],[v,v,v,v,v,v,v,v],[v,v,v,v,v,v,v,v],[v,v,v,v,v,v,v,v],[v,v,v,v,v,v,v,v],[v,v,v,v,v,v,v,v],[v,v,v,v,v,v,v,v]]},
              post:{head:[],width:8,height:8,board:[[a,r,a,r,a,r,a,r],[r,a,r,a,r,a,r,a],[a,r,a,r,a,r,a,r],[r,a,r,a,r,a,r,a],[a,r,a,r,a,r,a,r],[r,a,r,a,r,a,r,a],[a,r,a,r,a,r,a,r],[r,a,r,a,r,a,r,a]]},
            }]
          }
        ]
      }
    };

    const verEnunciado = function() {
      if ('ejercicio' in info) {
        alert(info.ejercicio.enunciado);
      } else {
        alert("No se cargó ningún ejercicio");
      }
    };

    const abrirEjercicio = function() {
      if ('curso' in info) {
        cargarEjercicios();
        document.getElementById("seleccionDeCurso").style.display = 'block';
        document.getElementById("ui").style.display = 'none';
      } else {
        fileChooser(function(jsonObj) {
          if (!['nombre','lenguaje','enunciado'].every(x => x in jsonObj)) {
            alert("Archivo inválido"); return;
          }
          delete info.curso;
          document.getElementById("selectorCurso").value = "0";
          cargarEjercicio(jsonObj);
        });
      }
    };

    const seleccionarEjercicio = function(i) {
      if (i !== null) {
        cargarEjercicio(cursos[info.curso].ejs[i]);
      }
      document.getElementById("seleccionDeCurso").style.display = 'none';
      document.getElementById("ui").style.display = 'block';
    };

    const cargarEjercicio = function(ej) {
      info.ejercicio = ej;
      if ('lenguaje' in ej) {
        document.getElementById("selectorLenguaje").value = ej.lenguaje;
      }
      document.getElementById('ejercicioSeleccionado').innerHTML = ej.nombre;
      document.getElementById('src').value = ('base' in ej ? ej.base : '');
    };

    const cambiarCurso = function() {
      seleccionarCurso(document.getElementById("selectorCurso").value);
    };

    const seleccionarCurso = function(k) {
      if (k !== document.getElementById("selectorCurso").value) {
        document.getElementById("selectorCurso").value = k;
      }
      if (k === '0') {
        delete info.curso;
        document.getElementById("lenguaje").style.display = 'inline';
      } else {
        info.curso = k;
        let curso = cursos[k];
        if ('lenguaje' in curso) {
          document.getElementById("selectorLenguaje").value = curso.lenguaje;
        }
        if ('lenguaje_display' in curso) {
          document.getElementById("lenguaje").style.display = curso.lenguaje_display;
        }
      }
      document.getElementById("seleccionDeCurso").style.display = 'none';
      document.getElementById("ui").style.display = 'block';
    };

    const fileChooser = function(callback, failCallback) {
      let selectFile = document.getElementById('select_file_wrapper');
      if (selectFile !== null) {
        selectFile.outerHTML = '';
      }
      let selectFileDom = document.createElement('INPUT');
      selectFileDom.type = 'file';
      selectFileDom.accept= '.rtx';
      selectFileDom.id = 'select_file';

      let selectFileWrapperDom = document.createElement('DIV');
      selectFileWrapperDom.id = 'select_file_wrapper';
      selectFileWrapperDom.style.display = 'none';
      selectFileWrapperDom.appendChild(selectFileDom);

      document.body.appendChild(selectFileWrapperDom);
      selectFile = document.getElementById('select_file');
      selectFile.addEventListener('change', function(e) {
        let archivo = e.target.files[0];
        if (archivo) {
          let reader = new FileReader();
          reader.onload = function() {
            try {
              let received = JSON.parse(reader.result);
              callback(received);
            } catch (e) {
              console.log(e);
              if (failCallback) { failCallback(); }
              else { alert("Archivo inválido"); }
            }
          };
          reader.readAsText(archivo);
        }
      }, false);
      selectFile.click();
    };

    const run_code = function() {
      const jsonObj = {
        src:document.getElementById("src").value,
        lenguaje:document.getElementById("selectorLenguaje").value,
      };
      if ('dni' in info) {
        jsonObj.dni = info.dni;
      } else if ('curso' in info) {
        const dni = prompt("Ingresá tu dni (sólo números)");
        if (dni) {
          info.dni = dni;
          jsonObj.dni = info.dni;
          document.getElementById("dni").innerHTML = "DNI: " + dni;
        }
      }
      if ('ejercicio' in info) {
        jsonObj.ejercicio = info.ejercicio.nombre;
        if ('run_data' in info.ejercicio) {
          jsonObj.run_data = info.ejercicio.run_data;
        }
        if ('pre' in info.ejercicio) {
          jsonObj.pre = info.ejercicio.pre;
        }
      }
      const callback = function(jsonObj) {
        if ('resultado' in jsonObj) {
          if ('error' in jsonObj) {
            if (jsonObj.error.startsWith("Ya había un programa definido en")) {
              if (ejercicioPidePrograma()) {
                alert("No podés definir más de un programa");
              } else {
                alert("El código funciona pero no cumple el enunciado");
              }
            } else {
              alert(jsonObj.error);
            }
          } else if (jsonObj.resultado == "Falla") {
            alert("El código funciona pero no cumple el enunciado");
          } else if (jsonObj.resultado == "OK") {
            alert("Misión cumplida");
          }
        } else {
          alert("ERROR: resultado faltante");
        }
        document.getElementById('src').focus();
      };
      const failCallback = function() {
        alert("ERROR: falló la comunicación con el servidor");
      };
      sendRequest('POST', 'code', callback, jsonObj, failCallback)
    };

    const ejercicioPidePrograma = function() {
      if ('ejercicio' in info) {
        return 'pidePrograma' in info.ejercicio;
      }
      return false;
    }

    const cargarCursos = function() {
      let contenidoPantalla = '';
      let contenidoSelector = '<option value="0" selected>Ninguno</option>';
      for (c in cursos) {
        contenidoPantalla += `<button onclick="seleccionarCurso('${c}');">${cursos[c].nombre}</button></br>`;
        contenidoSelector += `<option value="${c}">${cursos[c].nombre}</option>`
      }
      document.getElementById("selectorCurso").innerHTML = contenidoSelector;
      document.getElementById("seleccionDeCurso").innerHTML = contenidoPantalla +
        '<button onclick="seleccionarCurso(\'0\');">Libre</button>';
      document.getElementById("seleccionDeCurso").style.display = 'block';
    };

    const cargarEjercicios = function() {
      let contenidoPantalla = '';
      let i=0;
      for (ej of cursos[info.curso].ejs) {
        if (ejercicioDisponible(ej)) {
          contenidoPantalla += `<button onclick="seleccionarEjercicio(${i});">${ej.nombre}</button></br>`;
        }
        i++;
      }
      document.getElementById("seleccionDeCurso").innerHTML = contenidoPantalla +
        '<button onclick="seleccionarEjercicio(null);">Cancelar</button>';
    };

    const ejercicioDisponible = function(ej) {
      return !('mostrar' in ej) || ej.mostrar;
    }

    const sendRequest = function(method, path, callback, jsonObj, failCallback) {
      document.getElementById("ui").style.display = 'none';
      document.getElementById("espera").style.display = 'block';
      let request = createRequest();
      request.open(method, rutaAlServidor() + path, true);
      request.setRequestHeader('Content-type', 'application/json');
      request.onreadystatechange = function() {
        if (request.readyState == 4) {
          document.getElementById("espera").style.display = 'none';
          document.getElementById("ui").style.display = 'block';
          localStorage.clear();
          if (request.status == 200) {
            try {
              let received = JSON.parse(request.responseText);
              callback(received);
            } catch (e) {
              if (failCallback) { failCallback(); }
            }
          } else {
            if (failCallback) { failCallback(); }
          }
        }
      };
      if (jsonObj) {
        request.send(JSON.stringify(jsonObj));
      } else {
        request.send('');
      }
    };

    const createRequest = function() {
      var request = null;
      try { // Firefox, Chrome, IE7+, Opera, Safari
        request = new XMLHttpRequest();
      }
      catch (e) {
        try { // IE6 and earlier
          request = new ActiveXObject('Msxml2.XMLHTTP');
        }
        catch (e) {
          try {
            request = new ActiveXObject('Microsoft.XMLHTTP');
          }
          catch (e) {
            throw 'Your browser does not support AJAX';
            request = null;
          }
        }
      }
      return request;
    };

    const rutaAlServidor = function() {
      // return 'https://worker-production-de3a.up.railway.app/';
      return `http://${document.getElementById("url").value}:${document.getElementById("port").value}/`;
    };

    const parametroURL = function(clave) {
      let url = location.href;
      clave = clave.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");
      var regexS = "[\\?&]"+clave+"=([^&#]*)";
      var regex = new RegExp( regexS );
      var results = regex.exec( url );
      return results == null ? (url.startsWith('file') ? {curso:'inpr_unq_2023_s1', ej:0}[clave] : null) : results[1];
    };

    document.getElementById('src').addEventListener('keydown', function(e) {
      if (e.key == 'Tab') {
        e.preventDefault();
        var start = this.selectionStart;
        var end = this.selectionEnd;

        // set textarea value to: text before caret + tab + text after caret
        this.value = this.value.substring(0, start) +
          "  " + this.value.substring(end);

        // put caret at right position again
        this.selectionStart =
          this.selectionEnd = start + 2;
      }
    });

    let curso = parametroURL('curso');
    if (curso === null) {
      cargarCursos();
    } else {
      if (curso in cursos) {
        document.getElementById("curso").style.display = 'none';
        seleccionarCurso(curso);
        curso = cursos[curso];
        let ej = parametroURL('ej');
        if (ej !== null && ej < curso.ejs.length && ejercicioDisponible(curso.ejs[ej])) {
          cargarEjercicio(curso.ejs[ej]);
          document.getElementById("abrirEjercicio").style.display = 'none';
        }
        document.getElementById("ui").style.display = 'block';
      } else {
        cargarCursos();
      }
    }

    const dni = prompt("Ingresá tu dni");
    if (dni) {
      info.dni = dni;
      document.getElementById("dni").innerHTML = "DNI: " + dni;
      let sesionPrevia = localStorage.getItem(dni);
      if (sesionPrevia !== null) {
        document.getElementById('src').value = sesionPrevia;
      }
      setInterval(function() {
        localStorage.setItem(info.dni, document.getElementById('src').value);
      }, 1000);
    }
  </script>
</html>
